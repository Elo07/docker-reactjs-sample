trigger:
  - main

variables:
  acrLoginServer: 'cloudretailacr.azurecr.io'
  imageName: 'cloudretail-frontend'
  dockerHubImage: 'ehimwenma/cloudretail-frontend:v1'

stages:
- stage: CI
  displayName: 'CI â€” Retag and Push to ACR'
  jobs:
  - job: BuildAndPush
    displayName: 'Pull, Retag, Push'
    pool:
      name: 'CloudRetailAgentPool'
    steps:

    - script: |
        docker pull $(dockerHubImage)
        docker tag $(dockerHubImage) $(acrLoginServer)/$(imageName):$(Build.BuildId)
      displayName: 'Pull from Docker Hub and Retag'

    - task: Docker@2
      displayName: 'Push to ACR'
      inputs:
        command: push
        containerRegistry: 'cloudretailacr-connection'
        repository: '$(imageName)'
        tags: '$(Build.BuildId)'

    - script: |
        echo "$(Build.BuildId)" > $(Build.ArtifactStagingDirectory)/imagetag.txt
      displayName: 'Write image tag to file'

    - task: PublishPipelineArtifact@1
      displayName: 'Publish image tag artifact'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/imagetag.txt'
        artifact: 'imageTag'
  
- stage: Staging
  displayName: 'Deploy to Staging'
  dependsOn: CI
  condition: succeeded('CI')
  jobs:
  - job: DeployStaging
    displayName: 'Deploy to Staging Container App'
    pool:
      name: 'CloudRetailAgentPool'
    steps:

    - task: DownloadPipelineArtifact@2
      inputs:
        artifact: 'imageTag'
        path: '$(Pipeline.Workspace)/imageTag'

    - task: AzureCLI@2
      displayName: 'Deploy to Staging Azure Container App'
      inputs:
        azureSubscription: 'azure-connection'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          IMAGE_TAG=$(cat $(Pipeline.Workspace)/imageTag/imagetag.txt)
          IMAGE="cloudretailacr.azurecr.io/cloudretail-frontend:${IMAGE_TAG}"

          az containerapp create \
            --name cloudretail-staging \
            --resource-group cloudretail-vm_group \
            --environment cloudretail-env \
            --image "$IMAGE" \
            --registry-server cloudretailacr.azurecr.io \
            --target-port 8080 \
            --ingress external \
            --min-replicas 1 \
            --max-replicas 2 \
            --only-show-errors || \
          az containerapp update \
            --name cloudretail-staging \
            --resource-group cloudretail-vm_group \
            --image "$IMAGE"

          echo "Staging URL:"
          az containerapp show \
            --name cloudretail-staging \
            --resource-group cloudretail-vm_group \
            --query properties.configuration.ingress.fqdn \
            --output tsv

- stage: Production
  displayName: 'Deploy to Production'
  dependsOn: Staging
  condition: succeeded('Staging')
  jobs:
  - deployment: DeployProduction
    displayName: 'Deploy to Production Container App'
    pool:
      name: 'CloudRetailAgentPool'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: 'imageTag'
              path: '$(Pipeline.Workspace)/imageTag'

          - task: AzureCLI@2
            displayName: 'Deploy to Production Azure Container App'
            inputs:
              azureSubscription: 'azure-connection'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                IMAGE_TAG=$(cat $(Pipeline.Workspace)/imageTag/imagetag.txt)
                IMAGE="cloudretailacr.azurecr.io/cloudretail-frontend:${IMAGE_TAG}"

                az containerapp create \
                  --name cloudretail-production \
                  --resource-group cloudretail-vm_group \
                  --environment cloudretail-env \
                  --image "$IMAGE" \
                  --registry-server cloudretailacr.azurecr.io \
                  --target-port 8080 \
                  --ingress external \
                  --min-replicas 1 \
                  --max-replicas 3 \
                  --only-show-errors || \
                az containerapp update \
                  --name cloudretail-production \
                  --resource-group cloudretail-vm_group \
                  --image "$IMAGE"

                echo "Production URL:"
                az containerapp show \
                  --name cloudretail-production \
                  --resource-group cloudretail-vm_group \
                  --query properties.configuration.ingress.fqdn \
                  --output tsv
