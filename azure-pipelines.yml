trigger:
  - main

variables:
  acrLoginServer: 'cloudretailacr.azurecr.io'
  imageName: 'cloudretail-frontend'
  dockerHubImage: 'ehimwenma/cloudretail-frontend:v1'

stages:
- stage: CI
  displayName: 'CI â€” Retag and Push to ACR'
  jobs:
  - job: BuildAndPush
    displayName: 'Pull, Retag, Push'
    pool:
      name: 'CloudRetailAgentPool'
    steps:

    - script: |
        docker pull $(dockerHubImage)
        docker tag $(dockerHubImage) $(acrLoginServer)/$(imageName):$(Build.BuildId)
      displayName: 'Pull from Docker Hub and Retag'

    - task: Docker@2
      displayName: 'Push to ACR'
      inputs:
        command: push
        containerRegistry: 'cloudretailacr-connection'
        repository: '$(imageName)'
        tags: '$(Build.BuildId)'

    - script: |
        echo "$(Build.BuildId)" > $(Build.ArtifactStagingDirectory)/imagetag.txt
      displayName: 'Write image tag to file'

    - task: PublishPipelineArtifact@1
      displayName: 'Publish image tag artifact'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/imagetag.txt'
        artifact: 'imageTag'
